# 企业微信精准推送功能文档

## 概述

企业微信精准推送功能是一个基于用户购买行为和标签的自动化营销推送系统。该系统能够根据用户的历史订单、商品偏好、地理位置等多维度标签，在指定的时间自动向目标客户推送个性化的营销内容（文本、图片、小程序卡片等）。

## 核心功能模块

### 1. 精准推送配置管理
- 创建、编辑、查询精准推送规则
- 配置推送时间规则（支持按星期和具体时间设置）
- 设置用户筛选条件（标签、购买行为等）
- 配置推送内容（文本、图片、小程序卡片）

### 2. 定时任务执行
- 定时扫描符合条件的推送任务
- 根据标签和购买行为筛选目标用户
- 批量调用企业微信API进行消息推送
- 记录推送结果用于后续分析

### 3. 推送效果分析
- 统计推送人数、成功率、失败率
- 分析推送后的订单转化情况
- 查看推送产生的商品购买信息

## 系统架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                           管理后台界面                                │
├─────────────────────────────────────────────────────────────────────┤
│  • 创建/编辑推送规则    • 查看推送列表    • 推送效果分析              │
└──────────────────────────┬──────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        API 路由层                                     │
├─────────────────────────────────────────────────────────────────────┤
│  • /wechatpush/create    • /wechatpush/lists                        │
│  • /wechatpush/edit      • /wechatpush/info                         │
│  • /wechatpush/editstatus • /wechatpush/labels                      │
└──────────────────────────┬──────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       控制器层                                        │
├─────────────────────────────────────────────────────────────────────┤
│  WechatPushController                                               │
│  • 处理业务逻辑                                                       │
│  • 数据验证                                                          │
│  • 事务管理                                                          │
└──────────────────────────┬──────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        定时任务                                       │
├─────────────────────────────────────────────────────────────────────┤
│  createWechatPush (node-schedule)                                   │
│  • 每小时扫描待执行的推送任务                                          │
│  • 筛选目标用户                                                       │
│  • 批量推送消息                                                       │
└──────────────────────────┬──────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     企业微信服务层                                     │
├─────────────────────────────────────────────────────────────────────┤
│  wechatWorkService                                                  │
│  • getAccessToken()      获取企业微信访问令牌                         │
│  • getAttachments()      组装附件（图片/小程序卡片）                   │
│  • wechatPush()          调用企业微信群发API                          │
│  • mediaUpload()         上传临时素材                                 │
└──────────────────────────┬──────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      数据持久层                                       │
├─────────────────────────────────────────────────────────────────────┤
│  • wechat_push              推送配置表                               │
│  • wechat_push_time         推送时间规则表                           │
│  • wechat_push_results      推送结果记录表                           │
│  • wechat_labels            标签库表                                 │
│  • wechat_customers_labels  用户标签关联表                           │
│  • youzan_orders            有赞订单表                               │
│  • customers                客户信息表                               │
└─────────────────────────────────────────────────────────────────────┘
```

## 数据库设计

### 1. wechat_push（推送配置表）

| 字段名 | 类型 | 说明 |
|-------|------|------|
| id | BIGINT | 自增主键 |
| name | VARCHAR(255) | 推送名称（唯一） |
| status | INT | 状态（0-进行中，1-暂停） |
| start_date | VARCHAR(255) | 生效开始日期（YYYY-MM-DD） |
| end_date | VARCHAR(255) | 生效结束日期（YYYY-MM-DD） |
| city_labels | TEXT | 城市标签（逗号分隔） |
| store_labels | TEXT | 分仓标签（逗号分隔） |
| brand_labels | TEXT | 品牌标签（逗号分隔） |
| cate_labels | TEXT | 二级品类标签（逗号分隔） |
| sku_labels | TEXT | 商品SKU标签（逗号分隔） |
| last_order_day | INT | 上次下单间隔天数 |
| last_order_day_limit | INT | 上次下单间隔天数上限 |
| content | TEXT | 推送文本内容 |
| img | VARCHAR(255) | 图片地址 |
| mini_program_title | VARCHAR(255) | 小程序标题 |
| mini_program_img | VARCHAR(255) | 小程序图片地址 |
| mini_program_url | VARCHAR(255) | 小程序页面路径 |
| is_deleted | INT | 删除标记（0-未删除，1-已删除） |
| created_by | BIGINT | 创建人ID |
| updated_by | BIGINT | 修改人ID |
| created_at | VARCHAR(255) | 创建时间 |
| updated_at | VARCHAR(255) | 修改时间 |

### 2. wechat_push_time（推送时间规则表）

| 字段名 | 类型 | 说明 |
|-------|------|------|
| id | BIGINT | 自增主键 |
| name | VARCHAR(255) | 推送名称（关联wechat_push.name） |
| week_day | INT | 星期几（1-7，7表示周日） |
| push_time | VARCHAR(255) | 推送时间（HH:mm） |
| created_by | BIGINT | 创建人ID |
| updated_by | BIGINT | 修改人ID |
| created_at | VARCHAR(255) | 创建时间 |
| updated_at | VARCHAR(255) | 修改时间 |

### 3. wechat_push_results（推送结果表）

| 字段名 | 类型 | 说明 |
|-------|------|------|
| id | BIGINT | 自增主键 |
| name | VARCHAR(255) | 推送名称 |
| result | JSON | 推送结果详情 |
| created_at | VARCHAR(255) | 创建时间 |

**result JSON结构：**
```json
{
  "external_userid": ["用户ID1", "用户ID2"],
  "content": "推送内容",
  "attachments": [附件信息],
  "add": {
    "errcode": 0,
    "errmsg": "ok",
    "fail_list": ["失败的用户ID"],
    "msgid": "消息ID"
  }
}
```

### 4. wechat_labels（标签库表）

| 字段名 | 类型 | 说明 |
|-------|------|------|
| id | BIGINT | 自增主键 |
| bind_id | VARCHAR | 绑定ID（分仓/品类/SKU的ID） |
| name | VARCHAR | 标签名称 |
| type | INT | 标签类型（0-城市，1-分仓，2-二级品类，3-品牌，4-SKU） |

## 完整执行流程

### 第一阶段：推送规则配置

```
┌─────────────────────────────────────────────────────────────────┐
│  Step 1: 管理员创建推送规则                                       │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  管理员通过后台界面配置：                                          │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ • 推送名称: "45天未购买用户召回"                            │  │
│  │ • 生效日期: 2024-01-01 ~ 2024-12-31                       │  │
│  │ • 推送时间:                                                │  │
│  │   - 星期一 10:00                                          │  │
│  │   - 星期三 14:00                                          │  │
│  │   - 星期五 16:00                                          │  │
│  │ • 用户筛选条件:                                            │  │
│  │   - 城市: 上海,北京,苏州                                   │  │
│  │   - 品牌: 蓝氏,皇家                                       │  │
│  │   - 品类: 猫粮,猫砂                                       │  │
│  │   - 购买行为: 30-45天内有订单                             │  │
│  │ • 推送内容:                                               │  │
│  │   - 文本: "喵～主人，猫砂告急..."                         │  │
│  │   - 小程序卡片: 宠本本优惠页面                            │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  POST /wechatpush/create                                        │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  WechatPushController.createWechatPush()                        │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 1. 验证必填参数                                            │  │
│  │ 2. 验证日期格式                                            │  │
│  │ 3. 验证推送时间格式                                        │  │
│  │ 4. 检查推送名称是否重复                                    │  │
│  │ 5. 开启数据库事务                                          │  │
│  │    ├─ 插入 wechat_push 记录                               │  │
│  │    └─ 批量插入 wechat_push_time 记录                      │  │
│  │ 6. 提交事务                                               │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 第二阶段：定时任务扫描

```
┌─────────────────────────────────────────────────────────────────┐
│  Step 2: 定时任务触发（每小时执行一次）                           │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  crontab/youzan/wechat_push.js                                  │
│  createWechatPush()                                             │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  查询当前需要执行的推送任务                                        │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ SELECT a.*, b.week_day, b.push_time                       │  │
│  │ FROM wechat_push a                                        │  │
│  │ LEFT JOIN wechat_push_time b ON a.name = b.name          │  │
│  │ WHERE                                                     │  │
│  │   a.status = 0                    -- 进行中               │  │
│  │   AND a.is_deleted = 0            -- 未删除               │  │
│  │   AND a.start_date <= 当前日期     -- 已开始              │  │
│  │   AND a.end_date >= 当前日期       -- 未结束              │  │
│  │   AND b.week_day = 当前星期几       -- 匹配星期           │  │
│  │   AND b.push_time > 当前时间        -- 未执行             │  │
│  │   AND b.push_time <= 当前时间+60分钟 -- 即将执行          │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
           ┌─────┴─────┐
           │有任务吗？   │
           └─────┬─────┘
                 │ 是
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  遍历每个推送任务                                                 │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 3: 筛选目标用户                                            │
│  getExternalUserIds(推送任务配置)                                │
└─────────────────────────────────────────────────────────────────┘
```

### 第三阶段：用户筛选

```
┌─────────────────────────────────────────────────────────────────┐
│  Step 3.1: 根据购买时间筛选订单                                   │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 计算订单时间范围:                                          │  │
│  │   orderStartTime = 当前日期 - last_order_day_limit 天      │  │
│  │   orderEndTime = 当前日期 - last_order_day 天              │  │
│  │                                                            │  │
│  │ 示例: last_order_day=30, last_order_day_limit=45          │  │
│  │   筛选区间: [45天前, 30天前] 有过订单的用户                 │  │
│  │   意义: 45-30天内购买过，但最近30天没买的用户               │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  从 youzan_orders 表查询符合时间条件的订单                        │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ SELECT id, user_ids                                       │  │
│  │ FROM youzan_orders                                        │  │
│  │ WHERE order_creation_time                                 │  │
│  │   BETWEEN orderStartTime AND orderEndTime                 │  │
│  └──────────────────────────────────────────────────────────┘  │
│  提取所有 user_ids 并去重 → uniqueUids                          │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 3.2: 根据标签进一步筛选                                    │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 检查是否配置了标签条件:                                     │  │
│  │   • city_labels (城市)                                    │  │
│  │   • store_labels (分仓)                                   │  │
│  │   • cate_labels (品类)                                    │  │
│  │   • brand_labels (品牌)                                   │  │
│  │   • sku_labels (SKU)                                      │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────┬────────────────────────────────────────────────┘
                 │
           ┌─────┴─────┐
           │有标签配置？ │
           └─────┬─────┘
                 │ 是
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  从 wechat_labels 表查询匹配的标签ID                             │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ SELECT id FROM wechat_labels                              │  │
│  │ WHERE                                                     │  │
│  │   (type=0 AND name IN (城市列表))                         │  │
│  │   OR (type=1 AND bind_id IN (分仓列表))                   │  │
│  │   OR (type=2 AND bind_id IN (品类列表))                   │  │
│  │   OR (type=3 AND name IN (品牌列表))                      │  │
│  │   OR (type=4 AND bind_id IN (SKU列表))                    │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  从 wechat_customers_labels 表查询关联的用户                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ SELECT customer_id                                        │  │
│  │ FROM wechat_customers_labels                              │  │
│  │ WHERE                                                     │  │
│  │   label_id IN (标签ID列表)                                │  │
│  │   AND customer_id IN (uniqueUids)                         │  │
│  │   AND order_id IN (订单ID列表)                            │  │
│  └──────────────────────────────────────────────────────────┘  │
│  得到符合标签条件的 customerIds                                  │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  从 customers 表查询企业微信用户ID                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ SELECT external_userid                                    │  │
│  │ FROM customers                                            │  │
│  │ WHERE id IN (customerIds)                                 │  │
│  └──────────────────────────────────────────────────────────┘  │
│  得到最终的企微用户ID列表 → externalUserIds                      │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
           返回 externalUserIds
```

### 第四阶段：消息推送

```
┌─────────────────────────────────────────────────────────────────┐
│  Step 4: 批量推送消息                                             │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 将用户列表分页（每批最多10000人）                           │  │
│  │ pages = Math.ceil(externalUserIds.length / 10000)         │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  遍历每一批用户                                                   │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 4.1: 准备推送附件                                          │
│  getAttachments({ img, mini_program_* })                        │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 1. 获取企业微信 access_token                               │  │
│  │    - 优先从Redis缓存读取                                   │  │
│  │    - 缓存未命中则调用API获取并缓存2小时                     │  │
│  │                                                            │  │
│  │ 2. 如果配置了小程序卡片:                                    │  │
│  │    a. 从OSS下载小程序封面图                                │  │
│  │    b. 转换为FormData格式                                   │  │
│  │    c. 调用企业微信上传临时素材API                          │  │
│  │    d. 获取 media_id                                       │  │
│  │    e. 组装小程序卡片附件                                   │  │
│  │                                                            │  │
│  │ 3. 如果配置了图片:                                         │  │
│  │    a. 从OSS下载图片                                        │  │
│  │    b. 转换为FormData格式                                   │  │
│  │    c. 上传获取 media_id                                   │  │
│  │    d. 组装图片附件                                         │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 4.2: 调用企业微信群发API                                   │
│  wechatPush({ external_userid, content, attachments })         │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ POST https://qyapi.weixin.qq.com/cgi-bin/               │  │
│  │      externalcontact/add_msg_template                     │  │
│  │                                                            │  │
│  │ 请求参数:                                                  │  │
│  │ {                                                         │  │
│  │   "chat_type": "single",                                 │  │
│  │   "external_userid": ["用户ID1", "用户ID2", ...],         │  │
│  │   "text": {                                              │  │
│  │     "content": "推送文本内容"                             │  │
│  │   },                                                     │  │
│  │   "attachments": [                                       │  │
│  │     {                                                    │  │
│  │       "msgtype": "miniprogram",                          │  │
│  │       "miniprogram": {                                   │  │
│  │         "title": "小程序标题",                           │  │
│  │         "pic_media_id": "临时素材ID",                    │  │
│  │         "appid": "wx9be9e58fb9dc4dc2",                  │  │
│  │         "page": "pages/..."                             │  │
│  │       }                                                  │  │
│  │     }                                                    │  │
│  │   ]                                                      │  │
│  │ }                                                        │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  企业微信返回推送结果:                                            │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ {                                                         │  │
│  │   "errcode": 0,                                          │  │
│  │   "errmsg": "ok",                                        │  │
│  │   "fail_list": ["推送失败的用户ID"],                      │  │
│  │   "msgid": "msg8cRBDgAA..."                              │  │
│  │ }                                                        │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 4.3: 记录推送结果                                          │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ INSERT INTO wechat_push_results                           │  │
│  │ (name, result, created_at)                                │  │
│  │ VALUES (                                                  │  │
│  │   '推送名称',                                             │  │
│  │   {                                                       │  │
│  │     external_userid: [...],                              │  │
│  │     content: '...',                                      │  │
│  │     attachments: [...],                                  │  │
│  │     add: { ... 企业微信返回的结果 }                        │  │
│  │   },                                                      │  │
│  │   '2024-01-01 10:00:00'                                  │  │
│  │ )                                                        │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 第五阶段：效果分析

```
┌─────────────────────────────────────────────────────────────────┐
│  Step 5: 推送效果统计分析                                         │
│  WechatPushResultController.getWechatPushResult()               │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  查询推送结果记录                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ SELECT result FROM wechat_push_results                    │  │
│  │ WHERE                                                     │  │
│  │   created_at BETWEEN 开始时间 AND 结束时间                 │  │
│  │   AND name LIKE '%推送名称%'                              │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  统计推送数据                                                     │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 遍历所有推送记录的result字段:                              │  │
│  │                                                            │  │
│  │ pushList = 所有 external_userid (可能重复)                │  │
│  │ failList = 所有 fail_list (可能重复)                      │  │
│  │ successList = pushList - failList                        │  │
│  │                                                            │  │
│  │ 去重统计:                                                  │  │
│  │   uniquePushList = [...new Set(pushList)]                │  │
│  │   uniqueFailList = [...new Set(failList)]                │  │
│  │   uniqueSuccessList = [...new Set(successList)]          │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  查询推送后的订单转化                                             │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ SELECT COUNT(DISTINCT order_number) AS 订单数             │  │
│  │ FROM youzan_orders                                        │  │
│  │ WHERE                                                     │  │
│  │   order_creation_time BETWEEN 推送时间 AND 统计时间        │  │
│  │   AND fans_nickname IN (                                 │  │
│  │     SELECT DISTINCT name FROM customers                  │  │
│  │     WHERE external_userid IN (推送成功的用户ID)           │  │
│  │   )                                                      │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  返回统计结果                                                     │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ {                                                         │  │
│  │   "推送人数": 1000,                                       │  │
│  │   "推送失败人数": 50,                                     │  │
│  │   "推送成功人数": 950,                                    │  │
│  │   "产生订单数": 120                                       │  │
│  │ }                                                        │  │
│  │                                                           │  │
│  │ 转化率 = 120 / 950 = 12.6%                               │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## API 接口说明

### 1. 创建精准推送

**接口地址：** `POST /wechatpush/create`

**请求参数：**
```json
{
  "name": "45天未购买用户召回",
  "status": 0,
  "startDate": "2024-01-01",
  "endDate": "2024-12-31",
  "weekDayPushTime": [
    { "week": 1, "time": "10:00" },
    { "week": 3, "time": "14:00" },
    { "week": 5, "time": "16:00" }
  ],
  "cityLabels": "上海,北京,苏州",
  "storeLabels": "1001,1002",
  "brandLabels": "蓝氏,皇家",
  "cateLabels": "1001,1002",
  "skuLabels": "SKU001,SKU002",
  "lastOrderDay": 30,
  "lastOrderDayLimit": 45,
  "content": "喵～主人，猫砂告急...",
  "img": "https://oss.example.com/image.jpg",
  "miniProgramTitle": "宠本本优惠专场",
  "miniProgramImg": "https://oss.example.com/mini.jpg",
  "miniProgramUrl": "pages/home/feature/index?alias=xxx"
}
```

**参数说明：**
- `name`: 推送名称，必填，唯一
- `status`: 状态，0-进行中，1-暂停
- `startDate`: 生效开始日期
- `endDate`: 生效结束日期
- `weekDayPushTime`: 推送时间规则数组
  - `week`: 星期几，1-7（7表示周日）
  - `time`: 具体时间，HH:mm格式
- `cityLabels`: 城市标签，逗号分隔
- `storeLabels`: 分仓标签，逗号分隔
- `brandLabels`: 品牌标签，逗号分隔
- `cateLabels`: 品类标签，逗号分隔
- `skuLabels`: SKU标签，逗号分隔
- `lastOrderDay`: 距上次购买天数下限（例如30天）
- `lastOrderDayLimit`: 距上次购买天数上限（例如45天）
  - 组合含义：筛选45-30天内有购买的用户
- `content`: 推送文本内容
- `img`: 推送图片URL（可选）
- `miniProgramTitle`: 小程序卡片标题
- `miniProgramImg`: 小程序卡片封面图
- `miniProgramUrl`: 小程序页面路径

**响应示例：**
```json
{
  "success": true,
  "data": true
}
```

### 2. 编辑精准推送

**接口地址：** `POST /wechatpush/edit`

**请求参数：** 在创建接口基础上增加 `id` 字段

```json
{
  "id": 1,
  "name": "45天未购买用户召回-修改版",
  ...其他字段同创建接口
}
```

### 3. 修改推送状态

**接口地址：** `POST /wechatpush/editstatus`

**请求参数：**
```json
{
  "id": 1,
  "status": 1
}
```

### 4. 查询推送列表

**接口地址：** `POST /wechatpush/lists`

**请求参数：**
```json
{
  "searchText": "召回",
  "startTime": "2024-01-01",
  "endTime": "2024-12-31",
  "page": 1,
  "pagesize": 10
}
```

**响应示例：**
```json
{
  "success": true,
  "data": {
    "data": [
      {
        "id": 1,
        "name": "45天未购买用户召回",
        "createTime": "2024-01-01 10:00:00",
        "status": 0,
        "usefulTime": "2024-01-01~2024-12-31"
      }
    ],
    "total": 100,
    "page": 1,
    "pagesize": 10,
    "pages": 10
  }
}
```

### 5. 查询推送详情

**接口地址：** `POST /wechatpush/info`

**请求参数：**
```json
{
  "id": 1
}
```

**响应示例：**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "45天未购买用户召回",
    "status": 0,
    "startDate": "2024-01-01",
    "endDate": "2024-12-31",
    "weekDayPushTime": [
      { "week": 1, "time": "10:00" },
      { "week": 3, "time": "14:00" }
    ],
    "cityLabels": "上海,北京",
    "storeLabels": "1001,1002",
    "brandLabels": "蓝氏,皇家",
    "cateLabels": "1001,1002",
    "skuLabels": "SKU001",
    "lastOrderDay": 30,
    "lastOrderDayLimit": 45,
    "content": "推送内容...",
    "img": "https://...",
    "miniProgramTitle": "...",
    "miniProgramImg": "https://...",
    "miniProgramUrl": "pages/..."
  }
}
```

### 6. 查询标签库

**接口地址：** `POST /wechatpush/labels`

**响应示例：**
```json
{
  "success": true,
  "data": {
    "cityLabels": ["上海", "北京", "苏州"],
    "storeLabels": [
      { "id": "1001", "name": "上海仓" },
      { "id": "1002", "name": "北京仓" }
    ],
    "cateLabels": [
      { "id": "2001", "name": "猫粮" },
      { "id": "2002", "name": "猫砂" }
    ],
    "brandLabels": ["蓝氏", "皇家", "渴望"]
  }
}
```

## 核心代码文件

### 1. 控制器层
- **文件路径：** `controllers/wechat_push/wechat_push.js`
- **主要方法：**
  - `createWechatPush()` - 创建推送规则
  - `editWechatPush()` - 编辑推送规则
  - `editStatus()` - 修改推送状态
  - `getWechatPushList()` - 查询推送列表
  - `getWechatPushInfo()` - 查询推送详情
  - `getLabels()` - 查询标签库

### 2. 定时任务
- **文件路径：** `crontab/youzan/wechat_push.js`
- **主要方法：**
  - `createWechatPush()` - 主任务执行入口
  - `getExternalUserIds()` - 筛选目标用户

### 3. 企业微信服务层
- **文件路径：** `services/wechatWorkService.js`
- **主要方法：**
  - `getAccessToken()` - 获取企业微信访问令牌
  - `getAttachments()` - 组装推送附件
  - `wechatPush()` - 调用群发API
  - `mediaUpload()` - 上传临时素材
  - `transOssToFormData()` - OSS图片转FormData

### 4. 效果统计
- **文件路径：** `controllers/statistic/wechat_push_result.js`
- **主要方法：**
  - `getWechatPushResult()` - 统计推送效果

### 5. 路由配置
- **文件路径：** `routes/wechat_push/wechat_push.js`

### 6. 数据模型
- `models/customers_db/wechat_push.js` - 推送配置模型
- `models/customers_db/wechat_push_time.js` - 推送时间模型
- `models/customers_db/wechat_push_results.js` - 推送结果模型

## 关键技术点

### 1. 用户筛选逻辑

用户筛选采用"时间窗口 + 多维标签"的组合策略：

**时间窗口筛选：**
- `last_order_day` 和 `last_order_day_limit` 定义了一个时间区间
- 例如：`last_order_day=30, last_order_day_limit=45`
- 筛选条件：45天前 ≤ 最后购买时间 ≤ 30天前
- 业务含义：曾经是活跃用户（45天内买过），但最近流失了（30天没买）

**多维标签筛选：**
- 城市标签：用户所在城市
- 分仓标签：订单发货仓库
- 品类标签：购买的商品品类
- 品牌标签：购买的商品品牌
- SKU标签：具体的商品SKU

标签之间是"或"的关系，只要匹配其中任一标签即可。

### 2. 批量推送策略

为了避免单次推送用户过多导致API超时，采用分批推送策略：

- 每批最多推送 10,000 个用户
- 批次之间顺序执行
- 每批推送结果独立记录

```javascript
const MAX_BATCH_SIZE = 10000;
let pages = Math.ceil(externalUserIds.length / MAX_BATCH_SIZE);
for (let i = 1; i <= pages; i++) {
    let skip = (i - 1) * MAX_BATCH_SIZE;
    let externalUserIdsPageData = externalUserIds.slice(skip, skip + MAX_BATCH_SIZE);
    // 执行推送...
}
```

### 3. 企业微信 access_token 管理

- 使用 Redis 缓存 access_token
- 有效期：2小时
- 自动续期机制
- 请求失败时支持强制刷新

```javascript
async function getAccessToken(refresh = false) {
  let token = await redis.get("wechat_access_token");
  if (!token || refresh) {
    // 从企业微信API获取新token
    const response = await axios.get(
      `https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=${CORP_ID}&corpsecret=${CORP_SECRET}`
    );
    token = response?.data?.access_token ?? null;
    if (token) {
      await redis.setEx("wechat_access_token", token, 7200);
    }
  }
  return token;
}
```

### 4. 临时素材上传

企业微信的图片和小程序卡片需要先上传为临时素材：

1. 从OSS下载原图
2. 转换为FormData格式
3. 调用企业微信上传API
4. 获取 media_id
5. 使用 media_id 构建消息附件

```javascript
async function transOssToFormData({ url, filename = "image", key = "media" }) {
  const response = await axios.get(url, { responseType: "arraybuffer" });
  const form = new FormData();
  form.append(key, response.data, {
    filename: filename,
    contentType: response.headers["content-type"],
  });
  return form;
}

async function mediaUpload(accessToken, form, type = "image") {
  const response = await axios.post(
    `https://qyapi.weixin.qq.com/cgi-bin/media/upload?access_token=${accessToken}&type=${type}`,
    form,
    { headers: { "Content-Type": "multipart/form-data" } }
  );
  return response.data.media_id;
}
```

### 5. 事务处理

创建和编辑推送规则涉及多表操作，使用数据库事务保证数据一致性：

```javascript
await sequelize_customers.transaction(async (t) => {
    // 1. 插入或更新推送配置
    await WechatPush.create({...}, { transaction: t });
    
    // 2. 删除旧的推送时间配置
    await WechatPushTime.destroy({...}, { transaction: t });
    
    // 3. 批量插入新的推送时间配置
    await WechatPushTime.bulkCreate([...], { transaction: t });
});
```

## 定时任务配置

定时任务使用 `node-schedule` 实现：

```javascript
const schedule = require('node-schedule');

module.exports = () => {
    // 每小时执行一次（在每小时的0分执行）
    const time = "0 * * * *";
    schedule.scheduleJob(time, function () {
        createWechatPush();
    });
}
```

**Cron 表达式说明：**
- `"0 * * * *"` - 每小时的第0分钟执行
- 格式：秒 分 时 日 月 星期

## 推送效果评估指标

### 基础指标

1. **推送人数（Push Count）**
   - 定义：实际执行推送的用户总数
   - 计算：去重后的 external_userid 数量

2. **推送成功人数（Success Count）**
   - 定义：企业微信确认推送成功的用户数
   - 计算：推送人数 - 失败人数

3. **推送失败人数（Fail Count）**
   - 定义：企业微信返回推送失败的用户数
   - 计算：fail_list 去重后的数量

4. **推送成功率（Success Rate）**
   - 计算：推送成功人数 / 推送人数 × 100%

### 转化指标

5. **产生订单数（Order Count）**
   - 定义：推送后指定时间内，推送成功用户产生的订单数
   - 查询：统计推送时间到统计时间内的订单

6. **订单转化率（Conversion Rate）**
   - 计算：产生订单数 / 推送成功人数 × 100%

7. **购买用户数（Buyer Count）**
   - 定义：推送后产生订单的用户数
   - 计算：去重的购买用户ID数量

8. **用户转化率（User Conversion Rate）**
   - 计算：购买用户数 / 推送成功人数 × 100%

## 最佳实践建议

### 1. 推送时间选择

- **避免高峰时段：** 避开上下班通勤高峰（8-9点，17-18点）
- **推荐时段：**
  - 上午：10:00-11:30（工作间隙）
  - 下午：14:00-15:30（午休后）
  - 晚上：20:00-21:00（休闲时间）

### 2. 用户筛选策略

- **时间窗口设置：**
  - 高频消耗品（猫砂）：15-30天
  - 中频消耗品（猫粮）：30-45天
  - 低频商品（玩具）：60-90天

- **标签组合原则：**
  - 避免标签过于严格，导致用户数过少
  - 优先使用"或"逻辑，扩大覆盖面
  - 核心标签：品类 > 品牌 > 城市

### 3. 推送内容优化

- **文案要点：**
  - 简洁明了，突出优惠信息
  - 使用emoji增加亲和力
  - 包含明确的行动召唤（CTA）

- **小程序卡片：**
  - 标题吸引眼球（突出折扣）
  - 封面图清晰美观
  - 直达具体活动页面，减少跳转

### 4. 频次控制

- 同一用户每天最多接收1次推送
- 同一用户每周最多接收3次推送
- 建议设置推送间隔至少48小时

### 5. 效果监控

- 推送后24小时内密切关注转化数据
- 对比不同推送策略的效果差异
- 定期（每周/每月）生成效果报告
- 根据数据反馈调整推送策略

## 常见问题与解决方案

### 1. 推送失败率过高

**可能原因：**
- 用户已删除企业微信好友
- 用户设置了消息免打扰
- access_token 过期
- 临时素材上传失败

**解决方案：**
- 定期清理已删除的客户数据
- 检查 access_token 缓存机制
- 添加素材上传重试逻辑
- 记录详细的错误日志

### 2. 筛选用户数为0

**可能原因：**
- 标签配置过于严格
- 时间窗口设置不合理
- 标签数据未及时同步

**解决方案：**
- 放宽筛选条件
- 调整时间窗口范围
- 检查标签数据是否正常
- 执行标签同步任务

### 3. 定时任务未执行

**可能原因：**
- Cron 表达式配置错误
- 服务器时区不正确
- Node进程被终止

**解决方案：**
- 验证 Cron 表达式
- 统一服务器时区为 Asia/Shanghai
- 使用 PM2 等进程管理工具
- 添加任务执行日志

### 4. 转化率偏低

**可能原因：**
- 推送内容不够吸引人
- 推送时间选择不当
- 目标用户定位不准确
- 优惠力度不够

**解决方案：**
- A/B测试不同文案
- 优化推送时间
- 细分用户群体
- 调整营销策略

## 系统扩展建议

### 1. 功能扩展

- **智能推送时间：** 基于用户历史行为，预测最佳推送时间
- **个性化内容：** 根据用户偏好生成个性化推送文案
- **推送频次控制：** 添加用户维度的推送频次限制
- **A/B测试：** 支持同一批用户不同内容的对比测试
- **推送预览：** 在正式推送前支持小范围测试

### 2. 性能优化

- **用户筛选缓存：** 缓存筛选结果，避免重复计算
- **异步推送：** 使用消息队列实现异步推送
- **分布式任务：** 支持多服务器并行执行推送任务
- **数据库索引优化：** 优化关键查询的索引

### 3. 监控告警

- **推送失败告警：** 失败率超过阈值时触发告警
- **任务执行监控：** 定时任务执行异常时通知
- **API调用监控：** 企业微信API调用失败时记录
- **性能监控：** 监控任务执行时长和资源消耗

## 总结

企业微信精准推送系统是一个完整的自动化营销解决方案，核心流程包括：

1. **配置阶段：** 管理员创建推送规则，配置目标用户和推送内容
2. **扫描阶段：** 定时任务扫描待执行的推送任务
3. **筛选阶段：** 根据购买行为和标签筛选目标用户
4. **推送阶段：** 批量调用企业微信API推送消息
5. **统计阶段：** 记录推送结果，分析转化效果

该系统通过精准的用户定位、灵活的时间配置、丰富的推送形式，帮助企业实现高效的用户召回和转化。
